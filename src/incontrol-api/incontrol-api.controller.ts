import { Controller, Post, Body, HttpException } from '@nestjs/common';
import { IncontrolApiService } from './incontrol-api.service';
import * as fs from 'fs'; 
import * as path from 'path';
@Controller()
export class IncontrolApiController {
  constructor(private readonly incontrolApiService: IncontrolApiService) {}

  @Post('getimage')
  async getImage(@Body('image') base64Image: string) {
    try {
      // Verifica se a imagem foi recebida
      base64Image = 'data:image/jpeg;base64,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';
      if (!base64Image) {
        throw new HttpException('Imagem não recebida.', 400);
      }

      // Remove a parte do cabeçalho da imagem, se existir
      const base64Data = base64Image.replace(/^data:image\/\w+;base64,/, '');
      const buffer = Buffer.from(base64Data, 'base64');

      // Gera um nome único para a imagem
      const fileName = `image-${Date.now()}.png`;
      const filePath = path.join(__dirname, '..', '..', 'uploads', fileName); // Ajuste o caminho de destino

      // Salva o arquivo no sistema de arquivos
      fs.writeFileSync(filePath, buffer);

      // Envia a imagem para a API e obtém os dados
      const result = await this.incontrolApiService.uploadImage(filePath);

      // Retorna os resultados
      return result;
    } catch (error) {
      throw new HttpException(error.message, error.status);
    }
  }
}